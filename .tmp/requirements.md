# 要件定義書 - MIP MCP Server

## 1. 目的

LLMからのPuLPコードを受信し、MPS/LPファイルを生成してMIP最適化を実行するMCP（Model Context Protocol）サーバーを構築する。LLMクライアントはPuLPライブラリを使用してPythonコードを生成し、MCPサーバーがそのコードを実行してMPS/LPファイルを出力、pyscipoptで解決して結果を返却する。

## 2. 機能要件

### 2.1 必須機能

#### 基本MCP機能
- [ ] MCP対応のサーバー実装（fastmcpベース）
- [ ] streamable HTTPトランスポート対応（fastmcp標準機能）
- [ ] LLMクライアントとの双方向通信インターフェース
- [ ] LP/MPS形式での問題ファイル受信・処理

#### 最適化ソルバー統合
- [ ] pyscipopt（デフォルト）による最適化実行
- [ ] 設定ファイルによるソルバー切り替え機能（SCIP、Gurobi、CPLEX等）
- [ ] ソルバーパラメータの動的調整
- [ ] 最適化結果の構造化出力

#### Pythonコード実行機能（PuLP特化）
- [ ] PuLPライブラリを使用したPythonコード実行
- [ ] MPS/LPファイル生成機能
- [ ] 生成されたファイルの妥当性検証
- [ ] PuLPモデルからソルバー対応形式への変換

#### 問題検証・デバッグ支援
- [ ] 制約条件の数学的検証
- [ ] 実行不可能モデルの診断
- [ ] 制約緩和提案機能
- [ ] エラーメッセージの自然言語説明

### 2.2 オプション機能（将来実装）

- [ ] 複数最適化ライブラリ対応（pyomo、cvxpy等）
- [ ] 複数ソルバーでの結果比較
- [ ] ソリューションの感度分析
- [ ] 最適化プロセスの可視化

## 3. 非機能要件

### 3.1 パフォーマンス

- 処理性能はソルバーとマシン性能に依存（具体的な時間制約なし）
- ソルバー実行のプログレス情報提供
- メモリ使用量の適切な管理
- streamable HTTPによる効率的なデータ転送

### 3.2 セキュリティ

- 入力データの検証とサニタイゼーション
- ソルバー実行時のサンドボックス化
- 機密性の高い最適化データの保護
- ログ情報の適切な管理

### 3.3 保守性

- モジュラー設計による機能拡張の容易性
- 設定ファイルによる動作カスタマイズ
- 詳細なログ出力とデバッグ情報
- 包括的なユニットテストカバレージ

### 3.4 互換性

- 主要MIPソルバーとの互換性維持
- 既存のMCP実装との相互運用性
- Python 3.12以上での動作保証
- クロスプラットフォーム対応

### 3.5 クラウドデプロイメント

- Google Cloud Run環境での実行対応
- コンテナ化による可搬性確保
- ステートレス設計によるスケーラビリティ
- 環境変数による設定管理

## 4. 制約事項

### 4.1 技術的制約

- fastmcp v2.10.6以上の使用
- pyscipopt v5.5.0以上の使用
- Pythonベースの実装
- MCP仕様への準拠

### 4.2 ビジネス制約

- オープンソースライセンスでの提供
- 商用ソルバーは別途ライセンス必要
- 初期段階では基本機能の実装を優先

### 4.3 デプロイメント制約

- Cloud Run環境のメモリ・CPU制限への対応
- コールドスタート時間の最小化
- リクエストタイムアウト（最大60分）内での処理
- 永続ストレージなしでの動作

## 5. 成功基準

### 5.1 完了の定義

- [ ] MCP経由でLLMクライアントがPuLPコードを送信可能
- [ ] PuLPコードからMPS/LPファイルを生成
- [ ] 生成されたファイルをpyscipoptで解決
- [ ] 最適化結果（変数値、目的関数値、ステータス）を返却
- [ ] エラー処理と適切なフィードバックの提供
- [ ] streamable HTTPトランスポートでの通信確立
- [ ] Cloud Run環境での正常動作確認

### 5.2 受け入れテスト

- PuLPコードによるサンプル最適化問題の解決
- 線形計画・整数計画問題でのMPS/LP生成テスト
- 生成ファイルの妥当性検証テスト
- エラーケースでの適切な診断メッセージ表示
- MCP streamable HTTPでの通信テスト
- Cloud Run環境でのデプロイメントテスト
- コンテナ環境でのPuLP→MPS/LP→解決フローテスト

## 6. 想定されるリスク

### 技術リスク
- 商用ソルバーのライセンス・インストール複雑性
- MCP仕様の進化に伴う互換性問題
- 大規模問題でのメモリ・処理時間制約

### 運用リスク
- ソルバー依存関係の管理
- LLMとの通信エラー処理
- 不正な最適化問題入力の処理

### クラウド運用リスク
- Cloud Runのコールドスタート遅延
- メモリ・CPU制限による大規模問題の制約
- ネットワーク接続の不安定性
- 商用ソルバーライセンスのクラウド対応

### 対策
- 複数ソルバーでの代替実装
- 詳細なエラーハンドリング
- 入力検証の強化
- コンテナイメージの最適化
- ヘルスチェック機能の実装
- 適切なタイムアウト設定

## 7. 今後の検討事項

### 設計フェーズで詳細化すべき事項
- MCPサーバーのアーキテクチャ設計
- ソルバー抽象化層の設計
- Pythonコード実行環境の設計
- 設定管理システムの設計
- エラーハンドリング戦略
- テスト戦略とカバレージ計画
- Cloud Run デプロイメント戦略
- Dockerコンテナ設計

### 実装優先度の検討
- Phase 1: 基本MCP機能 + PuLP + pyscipopt統合
- Phase 2: MPS/LPファイル生成・処理機能
- Phase 3: Cloud Run対応 + コンテナ化
- Phase 4: 他最適化ライブラリ対応（pyomo、cvxpy等）
- Phase 5: 複数ソルバー対応

### 外部依存関係の調査
- PuLPライブラリの機能とMPS/LP出力形式
- pyscipoptとの互換性確認
- MCPクライアントとの連携テスト
- Cloud Runの制限事項とベストプラクティス
- コンテナ環境でのPuLP + pyscipoptの動作確認