# タスク分解書 - MIP MCP Server

## 1. 実装タスク概要

要件・設計に基づいて、PuLP特化のMIP MCP Serverを実装する。

### ワークフロー
```
LLM Client → PuLP Code → MCP Server → MPS/LP File → pyscipopt → Results → LLM Client
```

## 2. Phase 1: 基本MCP機能 + PuLP + pyscipopt統合

### 2.1 プロジェクト基盤セットアップ

#### T001: 依存関係の更新
- [ ] pyproject.tomlにPuLP依存関係追加
- [ ] 必要な依存関係のインストール確認
- [ ] 開発環境のセットアップ

**優先度**: High
**見積時間**: 0.5h
**成果物**: 更新されたpyproject.toml

#### T002: プロジェクト構造の作成
- [ ] src/mip_mcp/配下のディレクトリ構造作成
- [ ] 基本的な__init__.pyファイル作成
- [ ] 設定ファイルディレクトリの作成

**優先度**: High
**見積時間**: 0.5h
**成果物**: 基本プロジェクト構造

### 2.2 データモデル定義

#### T003: 基本データモデル実装
- [ ] models/solution.py: OptimizationSolution実装
- [ ] models/config.py: 設定データモデル実装
- [ ] Pydanticモデルの基本検証

**優先度**: High
**見積時間**: 1h
**成果物**: データモデルクラス

### 2.3 設定管理システム

#### T004: 設定管理実装
- [ ] utils/config_manager.py実装
- [ ] config/default.yaml作成
- [ ] 環境変数サポート実装

**優先度**: High
**見積時間**: 1h
**成果物**: 設定管理システム

#### T005: ログシステム実装
- [ ] utils/logger.py実装
- [ ] 構造化ログ出力設定
- [ ] ログレベル設定

**優先度**: Medium
**見積時間**: 0.5h
**成果物**: ログシステム

### 2.4 PuLPコード実行エンジン

#### T006: セキュリティチェッカー実装
- [ ] executor/sandbox.py実装
- [ ] ASTベースの危険コード検出
- [ ] SecurityError例外クラス定義

**優先度**: High
**見積時間**: 2h
**成果物**: セキュアなコード検証機能

#### T007: PuLP実行環境実装
- [ ] executor/code_executor.py実装
- [ ] PuLPライブラリの安全な実行環境
- [ ] 実行タイムアウト制御

**優先度**: High
**見積時間**: 2h
**成果物**: PuLP実行エンジン

#### T008: MPS/LP生成機能実装
- [ ] PuLPモデルからMPS形式生成
- [ ] PuLPモデルからLP形式生成
- [ ] 生成ファイルの妥当性検証

**優先度**: High
**見積時間**: 1.5h
**成果物**: ファイル生成機能

### 2.5 ソルバー統合

#### T009: ベースソルバークラス実装
- [ ] solvers/base.py実装
- [ ] 抽象ソルバーインターフェース定義
- [ ] エラーハンドリング基盤

**優先度**: High
**見積時間**: 1h
**成果物**: ソルバー抽象化基盤

#### T010: SCIPソルバー実装
- [ ] solvers/scip_solver.py実装
- [ ] MPS/LPファイル読み込み機能
- [ ] pyscipoptによる最適化実行
- [ ] 結果抽出機能

**優先度**: High
**見積時間**: 2h
**成果物**: SCIP統合機能

### 2.6 MCPサーバー実装

#### T011: MCPハンドラー実装
- [ ] handlers/execute_code.py実装
- [ ] PuLPコード実行ハンドラー
- [ ] エラーハンドリングとレスポンス形成

**優先度**: High
**見積時間**: 1.5h
**成果物**: MCP実行ハンドラー

#### T012: MCPサーバーメイン実装
- [ ] server.py実装
- [ ] FastMCPサーバー設定
- [ ] ハンドラー登録とルーティング

**優先度**: High
**見積時間**: 1h
**成果物**: MCPサーバー本体

#### T013: アプリケーションエントリーポイント
- [ ] __init__.py実装
- [ ] main()関数実装
- [ ] コマンドライン起動機能

**優先度**: High
**見積時間**: 0.5h
**成果物**: 実行可能アプリケーション

## 3. Phase 2: MPS/LPファイル生成・処理機能強化

### 3.1 ファイル処理機能拡張

#### T014: ファイル検証機能強化
- [ ] 生成されたMPS/LPファイルの構文検証
- [ ] ソルバー固有の制限事項チェック
- [ ] 詳細なエラーレポート機能

**優先度**: Medium
**見積時間**: 1.5h
**成果物**: 強化された検証機能

#### T015: ファイル最適化機能
- [ ] MPS/LPファイルの最適化（サイズ削減）
- [ ] 冗長な制約の検出と削除
- [ ] 変数名の正規化

**優先度**: Low
**見積時間**: 2h
**成果物**: ファイル最適化機能

### 3.2 エラーハンドリング強化

#### T016: 詳細エラー診断
- [ ] PuLPコードエラーの詳細分析
- [ ] ソルバーエラーの分類と説明
- [ ] 修正提案機能

**優先度**: Medium
**見積時間**: 2h
**成果物**: 高度なエラー診断機能

#### T017: カスタム例外クラス
- [ ] MIPMCPError基底クラス実装
- [ ] SolverError, ParseError等の専用例外
- [ ] 例外階層の整理

**優先度**: Medium
**見積時間**: 1h
**成果物**: 例外クラス体系

## 4. Phase 3: Cloud Run対応 + コンテナ化

### 4.1 コンテナ化

#### T018: Dockerfile作成
- [ ] マルチステージビルドDockerfile
- [ ] Python環境とソルバー依存関係
- [ ] セキュリティ最適化

**優先度**: High
**見積時間**: 2h
**成果物**: Dockerfile

#### T019: Docker環境テスト
- [ ] ローカルDockerビルドテスト
- [ ] コンテナ内でのPuLP + pyscipopt動作確認
- [ ] メモリ・CPU使用量測定

**優先度**: High
**見積時間**: 1h
**成果物**: 動作確認済みコンテナ

### 4.2 Cloud Run対応

#### T020: Cloud Run設定
- [ ] service.yaml作成
- [ ] 環境変数設定
- [ ] リソース制限設定

**優先度**: High
**見積時間**: 1h
**成果物**: Cloud Run設定ファイル

#### T021: ヘルスチェック実装
- [ ] /health エンドポイント実装
- [ ] システム状態監視機能
- [ ] 依存関係チェック

**優先度**: High
**見積時間**: 1h
**成果物**: ヘルスチェック機能

#### T022: Cloud Runデプロイメント
- [ ] gcloud CLIによるデプロイ
- [ ] 動作確認テスト
- [ ] パフォーマンス測定

**優先度**: High
**見積時間**: 1h
**成果物**: デプロイ済みサービス

## 5. テスト実装

### 5.1 ユニットテスト

#### T023: コアコンポーネントテスト
- [ ] PuLP実行エンジンテスト
- [ ] ソルバー統合テスト
- [ ] データモデルテスト

**優先度**: High
**見積時間**: 3h
**成果物**: ユニットテストスイート

#### T024: セキュリティテスト
- [ ] 危険なコードの検出テスト
- [ ] サンドボックス機能テスト
- [ ] 入力検証テスト

**優先度**: High
**見積時間**: 2h
**成果物**: セキュリティテストスイート

### 5.2 統合テスト

#### T025: エンドツーエンドテスト
- [ ] PuLP → MPS/LP → 解決フローテスト
- [ ] MCPクライアント統合テスト
- [ ] エラーケーステスト

**優先度**: High
**見積時間**: 2h
**成果物**: 統合テストスイート

#### T026: Cloud Run統合テスト
- [ ] コンテナ環境でのテスト
- [ ] Cloud Run環境でのテスト
- [ ] パフォーマンステスト

**優先度**: Medium
**見積時間**: 1.5h
**成果物**: クラウド統合テスト

## 6. ドキュメント作成

### 6.1 開発者向けドキュメント

#### T027: API仕様書
- [ ] MCPツール仕様
- [ ] リクエスト・レスポンス形式
- [ ] エラーコード一覧

**優先度**: Medium
**見積時間**: 2h
**成果物**: API仕様書

#### T028: 開発環境セットアップガイド
- [ ] 依存関係インストール手順
- [ ] 開発環境構築手順
- [ ] テスト実行方法

**優先度**: Medium
**見積時間**: 1h
**成果物**: 開発者ガイド

### 6.2 運用ドキュメント

#### T029: デプロイメントガイド
- [ ] Cloud Runデプロイ手順
- [ ] 設定オプション説明
- [ ] トラブルシューティング

**優先度**: Medium
**見積時間**: 1.5h
**成果物**: デプロイメントガイド

#### T030: 使用例とチュートリアル
- [ ] PuLPコード例
- [ ] 典型的な最適化問題の解決例
- [ ] トラブルシューティング事例

**優先度**: Low
**見積時間**: 2h
**成果物**: チュートリアル

## 7. 実装順序とマイルストーン

### Milestone 1: 基本機能完成 (Phase 1)
**期間**: 2-3日
**成果物**: 動作するMCP Server + PuLP + pyscipopt統合

**クリティカルパス**:
T001 → T002 → T003 → T006 → T007 → T008 → T010 → T011 → T012 → T013

### Milestone 2: 機能強化 (Phase 2)
**期間**: 1-2日
**成果物**: エラーハンドリング強化、ファイル処理改善

**並行実装可能**:
- T014, T015 (ファイル処理)
- T016, T017 (エラーハンドリング)

### Milestone 3: クラウド対応 (Phase 3)
**期間**: 1-2日
**成果物**: Cloud Run対応完了

**実装順序**:
T018 → T019 → T020 → T021 → T022

### Milestone 4: 品質保証
**期間**: 2-3日
**成果物**: テスト完備、ドキュメント整備

**並行実装可能**:
- T023, T024, T025 (テスト)
- T027, T028, T029 (ドキュメント)

## 8. リスク対応

### 高リスクタスク
- **T006**: セキュリティチェッカー - 複雑なAST解析
- **T008**: MPS/LP生成 - PuLPの出力形式への依存
- **T018**: Dockerfile - ソルバー依存関係の複雑性

### 代替案
- セキュリティチェッカーが複雑な場合 → 基本的な文字列チェックで代替
- MPS/LP生成に問題がある場合 → JSON形式での中間表現を使用
- Docker化に問題がある場合 → 標準Python環境での実行を優先

## 9. 品質基準

### コード品質
- テストカバレージ > 80%
- 型ヒント完備
- ドキュメント文字列完備

### パフォーマンス
- PuLPコード実行 < 30秒
- MPS/LP生成 < 5秒
- MCPレスポンス < 1秒 (ソルバー実行除く)

### セキュリティ
- 危険なコードの検出率 > 95%
- サンドボックス環境での隔離
- 入力検証完備
